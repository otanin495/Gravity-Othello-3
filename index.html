<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gravity Othello 3</title>
<style>
  :root{--board-size:90vw;--cell-size:calc(var(--board-size)/8);}
  @media(min-width:700px){:root{--board-size:480px;}}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;display:flex;flex-direction:column;align-items:center;padding:12px;background:#f4f6f8;color:#0b1220;}
  h1{font-size:18px;margin:8px 0;}
  #board{width:var(--board-size);height:var(--board-size);background:#27632a;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.15);display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);gap:0;}
  .cell{background:linear-gradient(180deg,#2f7f39,#1f5d2b);border:1px solid black;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;overflow:hidden}
  .piece{width:80%;height:80%;border-radius:50%;box-shadow:inset -6px -8px 12px rgba(0,0,0,0.25);transition:transform 0.2s linear;}
  .black{background:radial-gradient(circle at 30% 25%,#666 0%,#000 30%);} 
  .white{background:radial-gradient(circle at 30% 25%,#fff 0%,#ddd 50%);} 
  .valid-black::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:rgba(0,0,0,0.6);}
  .valid-white::after{content:'';position:absolute;width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.65);}
  .controls{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:8px;}
  button{flex:1 1 40%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:#fff;cursor:pointer;min-width:70px}
  button:disabled{opacity:0.5;cursor:not-allowed;}
  .info{background:#fff;padding:8px;border-radius:8px;box-shadow:0 6px 12px rgba(0,0,0,0.05);margin-top:6px;width:100%;max-width:400px}
  .legend{display:flex;gap:6px;align-items:center;margin-top:4px}
  #result{margin-top:10px;font-weight:bold;font-size:14px;color:#222;white-space:pre-line}
</style>
</head>
<body>
  <h1>Gravity Othello 3</h1>
  <div id="board"></div>
  <br></br>
  <div class="controls">
    <button class="gravityBtn" data-dir="down">↓</button>
    <button class="gravityBtn" data-dir="up">↑</button>
    <button class="gravityBtn" data-dir="left">←</button>
    <button class="gravityBtn" data-dir="right">→</button>
    <button id="resetBtn">リセット</button>
  </div>
  <div id="result"></div>
  <div class="info">
    <div><strong>現在の手番:</strong> <span id="turnDisplay">黒</span></div>
    <div class="legend"><div style="width:18px;height:18px;border-radius:50%;background:black"></div><div id="blackCount">2</div></div>
    <div class="legend"><div style="width:18px;height:18px;border-radius:50%;background:white;border:1px solid #ccc"></div><div id="whiteCount">2</div></div>
  </div>
<script>
const SIZE=8;
let board=[];
let current=1;
let animating=false;
let boardHistory=[];
const boardEl=document.getElementById('board');
const turnDisplay=document.getElementById('turnDisplay');
const blackCountEl=document.getElementById('blackCount');
const whiteCountEl=document.getElementById('whiteCount');
const resultEl=document.getElementById('result');
const gravityBtns=document.querySelectorAll('.gravityBtn');

function initBoard(){
  board=Array.from({length:SIZE},()=>Array(SIZE).fill(0));
  board[3][3]=-1; board[3][4]=1; board[4][3]=1; board[4][4]=-1;
  current=1;
  boardHistory=[];
  resultEl.textContent='';
  setButtons(true);
}

function render(){
  boardEl.innerHTML='';
  const valid=getValidMoves(board,current);
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      const cell=document.createElement('div');
      cell.className='cell';
      if(board[r][c]!==0){
        const p=document.createElement('div');
        p.className='piece '+(board[r][c]===1?'black':'white');
        cell.appendChild(p);
      }else if(valid[r][c]&&!animating){
        cell.classList.add(current===1?'valid-black':'valid-white');
      }
      if(!animating){
        cell.addEventListener('click',()=>onCellClick(r,c));
      }
      boardEl.appendChild(cell);
    }
  }
  const counts=countPieces(board);
  blackCountEl.textContent=counts.black;
  whiteCountEl.textContent=counts.white;
  turnDisplay.textContent=current===1?'黒':'白';
}

function inBounds(r,c){return r>=0&&r<SIZE&&c>=0&&c<SIZE}
const DIRS=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];

function getValidMoves(bd,player){
  const valid=Array.from({length:SIZE},()=>Array(SIZE).fill(false));
  for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
    if(bd[r][c]!==0) continue;
    for(const [dr,dc] of DIRS){
      let rr=r+dr,cc=c+dc;let cnt=0;
      while(inBounds(rr,cc)&&bd[rr][cc]===-player){rr+=dr;cc+=dc;cnt++;}
      if(cnt>0&&inBounds(rr,cc)&&bd[rr][cc]===player){valid[r][c]=true;break;}
    }
  }
  return valid;
}

function applyMove(r,c,player){
  board[r][c]=player;
  for(const[dr,dc]of DIRS){
    let rr=r+dr,cc=c+dc;let toFlip=[];
    while(inBounds(rr,cc)&&board[rr][cc]===-player){toFlip.push([rr,cc]);rr+=dr;cc+=dc;}
    if(inBounds(rr,cc)&&board[rr][cc]===player){for(const[fr,fc]of toFlip)board[fr][fc]=player;}
  }
  render();
  resultEl.textContent=(player===1?'黒':'白')+'が石を置いて返しました。';
}

function countPieces(bd){let black=0,white=0;for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){if(bd[r][c]===1)black++;else if(bd[r][c]===-1)white++;}return{black,white};}

function onCellClick(r,c){if(animating)return;const valid=getValidMoves(board,current);if(!valid[r][c])return;applyMove(r,c,current);endTurn();}

function endTurn(){
  if(checkGameEnd()){setButtons(false);return;}
  boardHistory.push(board.map(r=>r.slice()));
  current=-current;
  const valid=getValidMoves(board,current);
  if(!valid.flat().some(v=>v)){
    resultEl.textContent=(current===1?'黒':'白')+'は置ける場所がありません。盤を回転させてください。';
  }
  render();
  if(checkGameEnd()){setButtons(false);return;}
  updateGravityButtons();
}

async function applyGravity(dir){
  animating=true;
  setButtons(false);
  let moved=false;
  const delay=50;
  while(true){
    let stepMoved=false;
    if(dir==='down'){for(let r=SIZE-2;r>=0;r--){for(let c=0;c<SIZE;c++){if(board[r][c]!==0&&board[r+1][c]===0){board[r+1][c]=board[r][c];board[r][c]=0;stepMoved=true;}}}}
    else if(dir==='up'){for(let r=1;r<SIZE;r++){for(let c=0;c<SIZE;c++){if(board[r][c]!==0&&board[r-1][c]===0){board[r-1][c]=board[r][c];board[r][c]=0;stepMoved=true;}}}}
    else if(dir==='left'){for(let c=1;c<SIZE;c++){for(let r=0;r<SIZE;r++){if(board[r][c]!==0&&board[r][c-1]===0){board[r][c-1]=board[r][c];board[r][c]=0;stepMoved=true;}}}}
    else if(dir==='right'){for(let c=SIZE-2;c>=0;c--){for(let r=0;r<SIZE;r++){if(board[r][c]!==0&&board[r][c+1]===0){board[r][c+1]=board[r][c];board[r][c]=0;stepMoved=true;}}}}
    if(!stepMoved) break;
    moved=true;
    render();
    await new Promise(res=>setTimeout(res,delay));
  }
  animating=false;
  resultEl.textContent=(current===1?'黒':'白')+'が重力をかけました。';
  if(!checkGameEnd()){endTurn();}
  else{setButtons(false);document.getElementById('resetBtn').disabled=false;}
}

function setButtons(enabled){
  gravityBtns.forEach(btn=>btn.disabled=!enabled);
  document.getElementById('resetBtn').disabled=false;
  if(enabled) updateGravityButtons();
}

function updateGravityButtons(){
  gravityBtns.forEach(btn=>btn.disabled=false);
  gravityBtns.forEach(btn=>{
    if(btn.disabled) return;
    const testDir=btn.dataset.dir;
    let testBoard=board.map(r=>r.slice());
    let moved=false;
    if(testDir==='down'){for(let r=SIZE-2;r>=0;r--){for(let c=0;c<SIZE;c++){if(testBoard[r][c]!==0&&testBoard[r+1][c]===0){testBoard[r+1][c]=testBoard[r][c];testBoard[r][c]=0;moved=true;}}}}
    else if(testDir==='up'){for(let r=1;r<SIZE;r++){for(let c=0;c<SIZE;c++){if(testBoard[r][c]!==0&&testBoard[r-1][c]===0){testBoard[r-1][c]=testBoard[r][c];testBoard[r][c]=0;moved=true;}}}}
    else if(testDir==='left'){for(let c=1;c<SIZE;c++){for(let r=0;r<SIZE;r++){if(testBoard[r][c]!==0&&testBoard[r][c-1]===0){testBoard[r][c-1]=testBoard[r][c];testBoard[r][c]=0;moved=true;}}}}
    else if(testDir==='right'){for(let c=SIZE-2;c>=0;c--){for(let r=0;r<SIZE;r++){if(testBoard[r][c]!==0&&testBoard[r][c+1]===0){testBoard[r][c+1]=testBoard[r][c];testBoard[r][c]=0;moved=true;}}}}
    if(!moved) btn.disabled=true;
    for(const past of boardHistory){
      if(JSON.stringify(testBoard)===JSON.stringify(past)) btn.disabled=true;
    }
  });
}

function checkGameEnd(){
  const counts=countPieces(board);
  const validBlack=getValidMoves(board,1);
  const validWhite=getValidMoves(board,-1);
  const blackCan=validBlack.flat().some(v=>v);
  const whiteCan=validWhite.flat().some(v=>v);
  const filled=counts.black+counts.white===SIZE*SIZE;
  if(filled||(!blackCan&&!whiteCan)){
    let msg='終局\n';
    if(counts.black>counts.white){msg+='黒の勝ち ('+counts.black+' 対 '+counts.white+')';}
    else if(counts.white>counts.black){msg+='白の勝ち ('+counts.white+' 対 '+counts.black+')';}
    else{msg+='引き分け ('+counts.black+' 対 '+counts.white+')';}
    resultEl.textContent=msg;
    return true;
  }
  return false;
}

document.getElementById('resetBtn').addEventListener('click',()=>{initBoard();render();});
gravityBtns.forEach(btn=>btn.addEventListener('click',()=>{if(!animating)applyGravity(btn.dataset.dir);}));

initBoard();render();
</script>
</body>
</html>
